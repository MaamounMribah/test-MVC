@model BeeProj.Models.EngagementModel
@{
    ViewBag.Title = "Details";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@*<h2>Detailss</h2>*@
<style>
    .dataTables_filter, .dataTables_info, .dataTables_length {
        display: none;
    }
</style>
<style>
    .sel {
        -webkit-appearance: none;
        -moz-appearance: none;
    }
</style>
<link href="~/css/plugins/dataTables/datatables.min.css" rel="stylesheet">
<link href="~/css/plugins/chosen/bootstrap-chosen.css" rel="stylesheet">
<!-- Toastr style -->
<link href="~/css/plugins/toastr/toastr.min.css" rel="stylesheet">
<!-- Ladda style -->
<link href="~/css/plugins/ladda/ladda-themeless.min.css" rel="stylesheet">
<!-- Sweet Alert -->
<link href="~/css/plugins/sweetalert/sweetalert.css" rel="stylesheet">
<div class="row wrapper border-bottom white-bg page-heading">
    <div class="col-lg-10">
        <h2>Détails abonnement</h2>
        <ol class="breadcrumb">
            <li>
                <a href="@Url.Action("index","VenteLibre")">Acceuil</a>
            </li>
            <li>
                <a href="@Url.Action("Nouveau","VenteLibre")">Nouvel abonnement libre</a>
            </li>
            <li class="active">
                <strong>Détails</strong>
            </li>
        </ol>
    </div>
    <div class="col-lg-2">

    </div>
</div>
<div class="wrapper wrapper-content animated fadeInRight">
    <div class="row">
        <div class="row">
            <div class="col-lg-12">
                <div class="wrapper wrapper-content animated fadeInUp">

                    <div class="ibox">
                        <div class="ibox-title">
                            <h5 class="pull-left"><i title="Total" class="fa fa-calculator"><strong> Total Abonnement:</strong></i><label class="text-purplebee">  @String.Format("{0:N3}", @ViewBag.TotTTC) TND </label></h5>
                            @*<div class="ibox-tools">*@

                            <div class="text-right">
                                @if (ViewBag.EtapeAbo == 8)
                                {
                                    <h5 class="pull-right"><i title="Total" class="fa fa-close"><strong> Abonnement Annulé</strong></i></h5>
                                    <br />
                                }



                                @if (ViewBag.EtapeAbo < 4)
                                {

                                    if ((User.IsInRole("Admin")) || (User.IsInRole("Valider Vente Libre")))
                                    {
                                        <button class="btn btn-sm btn-outline btn-greenbee pull-right ladda-button ladda-button-demo" id="validerBord" type="button"><i title="Valider" class="fa fa-check"> Valider</i></button>
                                    }
                                    if ((User.IsInRole("Admin")) || (User.IsInRole("Ajouter Materiel Vente Libre")))
                                    {
                                        <button class="btn btn-sm btn-outline btn-greenbee right" style="margin-right:1%" id="ADDArticle" type="button"><i title="Ajouter Matériels" class="fa fa-plus"> Ajouter Matériels</i></button>
                                    }
                                    if ((User.IsInRole("Admin")) || (User.IsInRole("Annuler Materiel Vente Libre")))
                                    {
                                        <button type="button" title="Annuler la demande d'abonnement" class="btn btn-sm btn-outline btn-greenbee pull-right ladda-button ladda-button-demo"
                                                style="margin-right:1%" data-toggle="modal" data-target="#AnnulerAbo">
                                            <i class="fa fa-trash "> Annuler l'abonnement</i>
                                        </button>
                                    }
                                    <br />

                                }
                                else if (ViewBag.EtapeAbo == 4 && ((User.IsInRole("Admin") || User.IsInRole("BL Vente Libre"))))
                                {

                                    <button class="btn btn-sm btn-outline btn-greenbee pull-right ladda-button ladda-button-demo demo4" id="demo4" type="button"><i title="Bon de sortie" class="fa fa-sticky-note-o"> Bon de sortie</i></button>


                                    if ((User.IsInRole("Admin")) || (User.IsInRole("Annuler Materiel Vente Libre")))
                                    {
                                        <button type="button" title="Annuler la demande d'abonnement" class="btn btn-sm btn-outline btn-greenbee pull-right ladda-button ladda-button-demo"
                                                style="margin-right:1%" data-toggle="modal" data-target="#AnnulerAbo">
                                            <i class="fa fa-trash "> Annuler l'abonnement</i>
                                        </button>
                                    }

                                }
                                else if (ViewBag.EtapeAbo == 5 && ((User.IsInRole("Admin") || User.IsInRole("Payer Vente Libre"))))
                                {

                                    <button class="btn btn-sm btn-outline btn-greenbee pull-right ladda-button ladda-button-demo" id="AjouterReglement" type="button"><i title="Paiement" class="fa fa-money"> Paiement</i></button>

                                }
                                else if (ViewBag.EtapeAbo == 6 && (ViewBag.IsExistefacture.Count == 0)
                                    && ((User.IsInRole("Admin") || User.IsInRole("Facturer Vente Libre"))))
                                {
                                    <br />
                                    @*<a class="btn btn-sm btn-outline btn-greenbee pull-right ladda-button ladda-button-demo"
                                           title="Générer la facture" href="@Url.Action("premiereFacture","VenteLibre", new { id = Model.cbMarq })" target="_blank">
                                            <i title="Générer Facture" class="fa fa-print"> Générer Facture</i>
                                        </a>*@
                                    <button type="button" title="Générer Facture" class="btn btn-sm btn-outline btn-greenbee pull-right  m-l-sm" data-toggle="modal" data-target="#GénérerFacture">
                                        <i class="fa fa-times-circle "></i>
                                        Générer Facture
                                    </button>

                                }
                                @if (ViewBag.listeBL.Count != 0)
                                {
                                    <button type="button" style="margin-right:1%" class="btn btn-sm btn-outline btn-greenbee right ladda-button ladda-button-demo" title="Imprimer les BLs" data-toggle="modal" data-target="#ListeBL">
                                        <i title="ImprimerBL " class="fa fa-files-o">Imprimer BL</i>
                                    </button>

                                }
                                @if (ViewBag.IsExistefacture.Count != 0)
                                {
                                    <button type="button" style="margin-right:1%" class="btn btn-sm btn-outline btn-greenbee pull-right ladda-button ladda-button-demo" data-toggle="modal" data-target="#ListeFactures">
                                        <i title="Imprimer Facture " class="fa fa-print"> ImprimerFacture </i>
                                    </button>

                                }
                                @if (ViewBag.IsExisteReglement.Count != 0)
                                {
                                    <button type="button" style="margin-right:1%" class="btn btn-sm btn-outline btn-greenbee pull-right ladda-button ladda-button-demo" data-toggle="modal" data-target="#ShowListeReglements">
                                        <i title="Reçu de paiement" class="fa fa-check"> Réçu </i>
                                    </button>
                                    <br />
                                }



                            </div>

                            <br />
                            @*</div>*@
                        </div>
                        <div class="ibox-content">
                            <div class="row">
                                <div class="col-md-4">
                                    <h4><i class="fa fa-user"></i>  Intitule Client</h4>
                                    <h4 class="text-purplebee"> @Model.CT_Intitule</h4>
                                    <h4><i class="fa fa-home"></i>  Adresse</h4>
                                    <h4 class="text-purplebee"> @Model.CT_Adresse</h4>
                                    <h4><i class="fa fa-address-book"></i>  Complement Adresse</h4>
                                    <h4 class="text-purplebee"> @Model.CT_Complement</h4>
                                </div>
                                <div class="col-md-4">
                                    <h4><i class="fa fa-phone"></i>    Contact</h4>
                                    <h4 class="text-purplebee"> @Model.CT_Telephone </h4>

                                    <h4><i class="fa fa-bookmark"></i> Abonnement</h4>
                                    <h4 class="text-purplebee">@Model.DO_Piece</h4>
                                </div>
                                <div class="col-md-4">


                                    <h4><i class="fa fa-user-plus"></i> Agence Création</h4>
                                    <h4 class="text-purplebee">@Model.A_IntCreation</h4>
                                    @if (User.IsInRole("ChangeAgenceCreation") || User.IsInRole("Admin"))
                                    {
                                        <button type="button" class="btn btn-graybee" data-toggle="modal" title="Change Agence Creation"
                                                data-target="#ChangeAgenceCreation">
                                            <i class="fa fa-edit"></i>
                                        </button>
                                    }
                                    <h4><i class="fa fa-user-plus"></i> Agence livraison</h4>
                                    <h4 class="text-purplebee"> @Model.A_IntLivraison</h4>
                                    @if (ViewBag.EtapeAbo < 4)
                                    {
                                        if (User.IsInRole("ChangeAgenceCreation") || User.IsInRole("Admin"))
                                        {
                                            <button type="button" class="btn btn-graybee" data-toggle="modal" title="Change Agence livraison"
                                                    data-target="#ChangeAgenceLivraison">
                                                <i class="fa fa-edit"></i>
                                            </button>
                                        }
                                    }

                                </div>
                            </div>
                        </div>

                        <div class="ibox-content">
                            <div class="">
                                @if (ViewBag.EtapeAbo < 4)
                                {

                                    <table class="table ListeTransfert" id="ListeTransfert">
                                        <thead>

                                            <tr>

                                                <th class="project-status">
                                                    Matériels
                                                </th>
                                                <th>

                                                    N°Série
                                                </th>
                                                <th>

                                                    Quantité
                                                </th>

                                                <th>

                                                    Remise
                                                </th>

                                                <th>
                                                    Taxe
                                                </th>
                                                <th>
                                                    Prix unitaire
                                                </th>

                                                <th>
                                                    Prix HT
                                                </th>

                                                <th>
                                                    Prix Total
                                                </th>


                                            </tr>
                                        </thead>
                                    </table>

                                    @*<table class="table invoice-total">
                                            <tbody>

                                            <tr>
                                                <td><strong>Total :</strong></td>
                                                <td class="text-purplebee">@String.Format("{0:N3}", @ViewBag.TotTTC) TND </td>
                                            </tr>

                                            </tbody>
                                        </table>*@

                                }
                                else if (ViewBag.EtapeAbo >= 4)
                                {

                                    <table class="table  dataTables-example ListeTransfert2" id="ListeTransfert2">
                                        <thead>

                                            <tr>

                                                <th class="project-status">
                                                    Matériels
                                                </th>
                                                <th>

                                                    N°Série
                                                </th>
                                                <th>

                                                    Quantité
                                                </th>

                                                <th>

                                                    Remise
                                                </th>

                                                <th>
                                                    Taxe
                                                </th>
                                                <th>
                                                    Prix unitaire
                                                </th>

                                                <th>
                                                    Prix HT
                                                </th>

                                                <th>
                                                    Prix Total
                                                </th>


                                            </tr>
                                        </thead>

                                    </table>

                                    @*<table class="table invoice-total">
                                            <tbody>

                                                <tr>
                                                    <td><strong>Total :</strong></td>
                                                    <td class="text-purplebee">@String.Format("{0:N3}", @ViewBag.TotTTC) TND </td>
                                                </tr>

                                            </tbody>
                                        </table>*@
                                }



                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal inmodal" id="GénérerFacture" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content animated fadeIn">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title">Générer Facture</h4>
            </div>
            @using (Html.BeginForm("premiereFacture", "VenteLibre", FormMethod.Post, new { @class = "form-horizontal", role = "form" }))
            {
                <div class="modal-body">
                    @Html.HiddenFor(model => model.cbMarq)

                    <p style="text-align:center;font-size:25px;">Etes vous sur de vouloir générer la facture ?</p>

                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-white" data-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-purplebee ladda-button">Générer </button>
                </div>
            }
        </div>
    </div>
</div>
<div class="modal inmodal" id="validerBordereau" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content animated bounceInRight">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Fermer</span></button>
                <i class="fa fa-check-circle modal-icon"></i>
                <h4 class="modal-title">Reservation Matériels </h4>
                <small class="font-bold">Voulez vous vraiment confirmer la reservation des materiels selectionné!?</small>
            </div>
            <div class="modal-body">
                <div class="form-group"> <textarea placeholder="Commentaires " class="form-control" id="CommentairesTransfert"></textarea></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-white" data-dismiss="modal">Fermer</button>
                <button type="submit" class="btn btn-greenbee ladda-button ladda-button-demo" onclick="ValiderTransfert()">Valider </button>
            </div>
        </div>
    </div>
</div>
<!--Ajouter Reglement-->
<div class="modal inmodal" id="AjouterReglements" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content animated flipInY">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Fermer</span></button>
                <h4 class="modal-title">Ajouter Reglements </h4>
            </div>
            @using (Html.BeginForm("AjouterReglement", "VenteLibre", FormMethod.Post, new { @class = "form-horizontal", @name = "myForm", role = "form", enctype = "multipart/form-data" }))
            {
                <form role="form">
                    <div class="modal-body">
                        <div class="row">

                            <div class="form-group col-lg-12">
                                @Html.HiddenFor(model => model.cbMarq)
                                <input id="cbMarq" name="cbMarq" value=@Model.cbMarq style="display:none" />
                                <div class="row col-lg-12" id="TypeRecu">
                                    <label class="col-lg-6 control-label">Choisir votre mode de paiement <sup>*</sup></label>
                                    <div class="col-lg-6 ">
                                        <select class="form-control chosen-search" id="cbIndice" name="cbIndice">
                                            <option class="font-bold" value="2"> Choisir </option>

                                            @foreach (var item in ViewBag.ModeReglementAgence)
                                            {
                                                <option class="font-bold" value="@item.Value">@item.Text</option>
                                            }
                                        </select>
                                    </div>
                                </div>
                                <br />
                                <br />
                                <br />
                                <div class="row col-lg-12" id="ifospayement" style="display:none">
                                    <div class="form-group col-lg-12">
                                        <label class="col-lg-6 control-label">Identifiant <sup>*</sup></label>
                                        <div class="col-lg-6">
                                            <input type="text" class="form-control" name="identifiantpay" id="identifiantpay" placeholder="N° Chèque,Référence de paiement TPE , N° Compte du client," />
                                        </div>
                                    </div>
                                    <div class="form-group col-lg-12">
                                        <label class="col-lg-6 control-label">Libellé</label>
                                        <div class="col-lg-6">
                                            <input type="text" class="form-control" name="libelle" id="libelle" placeholder="Nom de la banque,N° Ordre de virement" />
                                        </div>
                                    </div>
                                    <div class="form-group col-lg-12">
                                        <label class="col-lg-6 control-label">Description</label>
                                        <div class="col-lg-6">
                                            <input type="text" class="form-control" name="description" id="description" placeholder="Titulaire du Chèque" />
                                        </div>
                                    </div>
                                    <div class="form-group col-lg-12">
                                        <label class="col-lg-6 control-label">Date Echéance </label>
                                        <div class="col-lg-6">
                                            <input type="text" pattern="\d{1,2}/\d{1,2}/\d{4}" class="form-control" name="dateecheance" id="dateecheance" placeholder="Date d'échéance du chèque (format : jj/mm/aaaa)" />
                                        </div>
                                    </div>
                                </div>


                                <br />




                            </div>
                            @*</form>*@
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="submit" class="btn btn-greenbee">Valider</button>
                    </div>
                </form>

            }
        </div>
    </div>
</div>
<!--liste des reglements-->
<div class="modal inmodal" id="ShowListeReglements" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content animated flipInY">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Fermer</span></button>
                <h4 class="modal-title">Liste des règlements </h4>
            </div>
            <div class="modal-body">
                <div class="row">
                    <form role="form">
                        <div class="form-group">
                            @if (ViewBag.IsExisteReglement.Count == 0)
                            {
                                <p>Aucune Facture </p>

                            }
                            else
                            {
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Statut</th>
                                            <th>Référence</th>
                                            <th>Date </th>
                                            <th>Montant TTC</th>
                                            <th>Voir </th>
                                        </tr>
                                    </thead>

                                    <tbody>
                                        @foreach (var item in ViewBag.IsExisteReglement)
                                        {

                                            <tr>
                                                <td>
                                                    @if (item.DO_Statut == 1)
                                                    {
                                                        <span class="label label-default"><i class="fa fa-check"></i> Non versé</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="label label-success"><i class="fa fa-check"></i> Versé</span>

                                                    }


                                                </td>
                                                <td>
                                                    @item.DO_Piece
                                                </td>
                                                <td>
                                                    @item.DO_Date.ToString("dd/MM/yyyy")
                                                </td>
                                                <td>
                                                    @String.Format("{0:N3}", item.DO_MontantTTC) TND
                                                </td>
                                                <td>
                                                    <a class="btn btn-greenbee btn-circle btn-outline" title="voir le reçu de paiement "
                                                       href="@Url.Action("ImpressionRecu","GestionFactures", new { id = item.cbMarq })" target="_blank">
                                                        <i title="Imprimer Reçu " class="fa fa-print"></i>
                                                    </a>

                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            }

                        </div>
                    </form>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-greenbee" data-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>
<!--liste des factures-->
<div class="modal inmodal" id="ListeFactures" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content animated flipInY">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Fermer</span></button>
                <h4 class="modal-title">Liste des factures </h4>
            </div>
            <div class="modal-body">
                <div class="row">
                    <form role="form">
                        <div class="form-group">
                            @if (ViewBag.IsExistefacture.Count == 0)
                            {
                                <p>Aucune Facture </p>

                            }
                            else
                            {
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Type Document</th>
                                            <th>N° Pièce</th>
                                            <th>Date </th>
                                            <th>Référence</th>
                                            <th>Montant TTC</th>
                                            <th>Voir </th>
                                        </tr>
                                    </thead>

                                    <tbody>
                                        @foreach (var item in ViewBag.IsExistefacture)
                                        {

                                            <tr>
                                                <td>
                                                    @if (item.DO_Statut == 0)
                                                    {
                                                        <span class="label label-default"><i class="fa fa-check"></i> En Cours</span>
                                                    }
                                                    else if (item.DO_Statut == 1)
                                                    {
                                                        <span class="label label-success"><i class="fa fa-check"></i> Payée</span>

                                                    }
                                                    else if (item.DO_Statut == 2)
                                                    {
                                                        <span class="label label-info"><i class="fa fa-check"></i> Versée</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="label label-danger"><i class="fa fa-check"></i>Validée</span>
                                                    }

                                                </td>
                                                <td>
                                                    @item.DO_Piece
                                                </td>
                                                <td>
                                                    @item.DO_Date.ToString("dd/MM/yyyy")
                                                </td>
                                                <td>@item.DO_Ref</td>

                                                <td>
                                                    @String.Format("{0:N3}", item.DO_totalTTC /*+ (decimal)0.600*/) TND
                                                </td>

                                                <td>

                                                    <a class="btn btn-purplebee btn-circle   btn-outline" title="voir la facture"
                                                       href="@Url.Action("VisualiserFacture","VenteLibre", new { id = item.cbMarq })" target="_blank">
                                                        <i title="Imprimer Facture " class="fa fa-print"></i>
                                                    </a>


                                                </td>
                                            </tr>

                                        }
                                    </tbody>
                                </table>
                            }

                        </div>
                    </form>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-greenbee" data-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>
<!-- Modal liste article  -->
<div class="modal inmodal" id="selectArticle" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title">Liste des articles en stock</h4>
                <small class="font-bold">Click sur "valider" pour affecter l'article de votre demande et préciser la quantité désirée.</small>

                <br />
                <hr />


                <div class="form-group">
                    <label class="col-sm-2 control-label">Quantité Demander</label>

                    <div class="col-sm-10">
                        <div class="input-group m-b">
                            <span class="input-group-addon">
                                <i class="fa fa-star"></i>
                            </span> <input type="number" class="form-control" placeholder="Quantité" id="qtyEntree" value="1">
                        </div>
                    </div>

                </div>
                <br />

                @if ((User.IsInRole("Admin")))
                {

                    <div class="form-group">
                        <label class="col-sm-2 control-label">Remise</label>

                        <div class="col-sm-10">
                            <div class="input-group m-b">
                                <span class="input-group-addon">
                                    <i class="fa fa-star"></i>
                                </span> <input type="text" class="form-control" value=0 placeholder="Remise" id="Remise">
                            </div>
                        </div>

                    </div>
                    <br />
                }

                <div class="form-group">
                    <label class="col-sm-2 control-label">Article sélectionné</label>
                    <div class="col-sm-10">
                        <div class="input-group m-b col-lg-12">
                            <select class="chosen-select form-control chosen-search" id="Article">
                                <option value="">Selectionner</option>
                                @foreach (var item in ViewBag.Articledispo)
                                {
                                    <option value=@item.AR_Ref>@item.AR_Design</option>
                                }
                            </select>
                        </div>
                    </div>
                    <br />

                </div>
            </div>



            <div class="modal-body">


                <div class="table-responsive">

                    <table id="listeArticles" class="table table-striped table-bordered table-hover dataTables-example full-width" style="cursor:pointer;">
                        <thead>
                            <tr>



                                <th>
                                    Référence Article
                                </th>
                                <th>
                                    Désignation
                                </th>
                                <th>Quantité Disponible </th>

                                <th>
                                    Quantité Réservée
                                </th>





                            </tr>
                        </thead>



                    </table>

                </div>

            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-white" data-dismiss="modal">Fermer</button>
                <button type="submit" class="btn btn-greenbee ladda-button ladda-button-demo" onclick="ValiderADDarticle()">Valider </button>
            </div>
        </div>
    </div>
</div>
<!--liste des bl-->
<div class="modal inmodal" id="ListeBL" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content animated flipInY">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Fermer</span></button>
                <h4 class="modal-title">Liste des bon de sortie </h4>
            </div>
            <div class="modal-body">
                <div class="row">
                    <form role="form">
                        <div class="form-group">
                            @if (ViewBag.listeBL == null)
                            {
                                <p>Aucune BL </p>

                            }
                            else
                            {
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>N° BL</th>
                                            <th>Date</th>
                                            <th>Voir </th>
                                        </tr>
                                    </thead>

                                    <tbody>
                                        @foreach (var item in ViewBag.listeBL)
                                        {

                                            <tr>
                                                <td>
                                                    @item.DO_Piece
                                                </td>
                                                <td>
                                                    @item.DO_Date.ToString("dd/MM/yyyy")
                                                </td>
                                                <td>
                                                    <a class="btn btn-purplebee btn-circle   btn-outline" title="voir la BL"
                                                       href="@Url.Action("ImprimerBL","VenteLibre", new { id = item.cbMarq })" target="_blank">
                                                        <i title="Imprimer BL " class="fa fa-print"></i>
                                                    </a>

                                                </td>
                                            </tr>

                                        }
                                    </tbody>
                                </table>
                            }

                        </div>
                    </form>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-greenbee" data-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

<!--Annuler abo-->
<div class="modal inmodal" id="AnnulerAbo" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content animated fadeIn">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title">Choisir motif d'annulation</h4>
            </div>
            @using (Html.BeginForm("AnnulerAbonnement", "VenteLibre", FormMethod.Post, new { @class = "form-horizontal", role = "form" }))
            {
                <div class="modal-body">
                    @Html.HiddenFor(model => model.cbMarq)
                    <input id="cbMarq" name="cbMarq" value=@Model.cbMarq style="display:none" />
                    <div class="form-group">
                        <label class="control-label">Motif</label>
                        <div class="">
                            <select class="col-md-6 form-control chosen-select Motif_Annulation" id="Motif_Annulation" name="Motif_Annulation">
                                <option class="font-bold" value="Aucun motif"> Aucun motif </option>

                                @if (ViewBag.liste != null)
                                {
                                    foreach (var item in ViewBag.Motifannulation)
                                    {
                                        <option class="font-bold" value="@item.Motif"> @item.Motif </option>
                                    }
                                }
                            </select>

                        </div>
                    </div>

                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-white" data-dismiss="modal">Non</button>
                    <button type="submit" class="btn btn-purplebee ladda-button">Oui </button>
                </div>
            }
        </div>
    </div>
</div>

@*Modification agence creatrice suite demende houssem*@
<div class="modal inmodal" id="ChangeAgenceCreation" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content animated bounceIn">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Fermer</span></button>
                <h4 class="modal-title">Changement Agence creation</h4>
            </div>
            @using (Html.BeginForm("ChangeAgenceCreation", "Abonnement", FormMethod.Post, new { @class = "form-horizontal", role = "form" }))
            {
                <div class="modal-body">
                    @Html.HiddenFor(model => model.cbMarq)
                    <fieldset class="form-horizontal">
                        <i>Etes vous sur de vouloir changer l'agence creation de cet abonnement  ?</i>
                        <div class="form-group ">
                            <select class="form-control chosen-select" name="A_CodeCreation" id="A_CodeCreation">

                                @foreach (var item in ViewBag.ListOfAgences)
                                {
                                    if (item.Value == Model.A_IntCreation)
                                    {
                                        <option value="@item.Value" selected>@item.Text</option>
                                    }
                                    else
                                    {
                                        <option value="@item.Value">@item.Text</option>
                                    }
                                }
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">Remarque </label>
                            <div class="col-sm-10">
                                <textarea type="text" class="form-control" id="RemarqueChangement"></textarea>
                            </div>
                        </div>
                    </fieldset>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-white" data-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-warning">Oui </button>
                </div>
            }
        </div>
    </div>
</div>


<!-- Modal add new note -->
<div class="modal inmodal" id="ChangeAgenceLivraison" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content animated bounceIn">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Fermer</span></button>
                <h4 class="modal-title">Changement Agence Livraison</h4>
            </div>
            @using (Html.BeginForm("ChangerAgenceLivraison", "Abonnement", FormMethod.Post, new { @class = "form-horizontal", role = "form" }))
            {
                <div class="modal-body">
                    @Html.HiddenFor(model => model.cbMarq)
                    <fieldset class="form-horizontal">
                        <i>Etes vous sur de vouloir changer l'agence livraison de cet abonnement  ?</i>
                        <div class="form-group ">
                            <select class="form-control chosen-select" name="A_CodeLivraison" id="A_CodeLivraison">

                                @foreach (var item in ViewBag.ListOfAgences)
                                {
                                    if (item.Value == Model.A_CodeLivraison)
                                    {
                                        <option value="@item.Value">@item.Text</option>
                                    }
                                    else
                                    {
                                        <option value="@item.Value">@item.Text</option>
                                    }
                                }
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">Remarque </label>
                            <div class="col-sm-10">
                                <textarea type="text" class="form-control" id="RemarqueChangement"></textarea>
                            </div>
                        </div>
                    </fieldset>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-white" data-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-warning">Oui </button>
                </div>
            }
        </div>
    </div>
</div>

<script src="~/js/jquery-3.1.1.min.js"></script>
<script src="~/js/plugins/metisMenu/jquery.metisMenu.js"></script>
<script src="~/js/plugins/pace/pace.min.js"></script>
<script src="~/js/plugins/slimscroll/jquery.slimscroll.min.js"></script>
<script src="~/js/plugins/chosen/chosen.jquery.js"></script>
<script src="~/js/plugins/dataTables/datatables.min.js"></script>
<!-- Toastr script -->
<script src="~/js/plugins/toastr/toastr.min.js"></script>
<!-- Ladda -->
<script src="~/js/plugins/ladda/spin.min.js"></script>
<script src="~/js/plugins/ladda/ladda.min.js"></script>
<script src="~/js/plugins/ladda/ladda.jquery.min.js"></script>
<!-- Sweet alert -->
<script src="~/js/plugins/sweetalert/sweetalert.min.js"></script>

<script>

    $(document).ready(function () {
        $('.chosen-select').chosen({ width: "100%" });
        $('#demo4').click(function () {
            swal({
                title: "Générer des BLs",
                text: "Vous validez la livraison des articles listés ",
                type: "warning",
                showCancelButton: true,
                showConfirmButton: true,
                confirmButtonColor: "#DD6B55",
                confirmButtonText: "Oui, je confirme",
                cancelButtonText: "Annuler",
                closeOnConfirm: false,
                closeOnCancel: false },
                    function (isConfirm) {
                        if (isConfirm) {
                            $.ajax({
                                type: "Post",
                                url: "/VenteLibre/GenererBL?cbmarq=" + @Model.cbMarq,
                                success: function (data) {
                                    swal("success!", "Confirmation des articles reçus ", "success");
                                    window.location = "/VenteLibre/Details/@Model.cbMarq";
                                }
                            });


                        } else {
                            swal("Aucun changement", "Si vous n'avez pas encore reçu ces articles, consultez votre supérieur", "error");
                        }
                    });
        });

        $(".chosen-select").chosen();
        var table = $('#ListeTransfert').DataTable({
            "ajax": {
                "url": '/VenteLibre/getlisteLigne?cbMarq=' + @Model.cbMarq,
                "type": "get",
                "datatype": "json",
                "autoWidth": false,
                "ordering": false,


            },
            paging: false,
            "columns": [
                    { "data": "Materiels" },
                    { "data": "cbMarq" },
                    { "data": "Quantite" },
                    { "data": "Remise"},
                    { "data": "Taxe" },
                    { "data": "PrixUnitaire" },
                    { "data": "PrixHT" },
                    { "data": "PrixTotal" },


            ],
            "columnDefs": [
                    {
                        targets: [0],
                        render: function (data, type, row) {
                                return '<label class="label text-purplebee">'+data+'</label>';
                        }
                    }
                    ,
                    {
                        targets: [1],
                        render: function (data, type, row) {
                            var url= "/VenteLibre/LoadSerie3?Ref="+ data,
                            getservice= function(url){
                                var res= $.ajax({
                                    type: "POST",
                                    url: url,
                                    dataType: "json",
                                    async: false,
                                    success: function(data){
                                    }
                                }).responseText;

                                return res;
                            }
                            var ListeSeries = getservice(url) ;
                            var d = JSON.parse(ListeSeries);
                            let id = "'" + data + "'";
                            var mylist = '<select  class="chosen-select form-control " id=' + id +' style="width:200px;height:30px">';
                            mylist = mylist + '<option value="'+ data +'">Aucun</option>'
                            for (var i = 0; i < d.data.length; i++) {
                                var counter = d.data[i];
                                mylist = mylist + '<option value="'+ data +'">'+ counter.LS_NoSerie + '</option>' ;
                            }
                            mylist = mylist +'</select>' ;
                            $(".chosen-select").chosen();
                            $('#' + data).click(function(e){
                                $('#' + data+' option:selected').prop('selected', false);
                            });
                            //if (d.count == 0)
                            //{
                            //    return '<select class="form-control sel disabled" style="width:200px;height:30px" readonly><option value="'+ data +'">'+ d.data + '</option></select>';
                            //}
                            //else {
                                return mylist;
                           // }
                            $(document).ready(function () {
                                $('.chosen-select').chosen({ width: "100%" });
                                $('#' + data).addClass('chosen-select');
                                $("#" + data).trigger("chosen:updated");
                                $('.chosen-select').chosen({ width: "100%" });
                            });
                        }

                    }
            ]

        });
        $(".chosen-select").chosen();

        var table2 = $('#ListeTransfert2').DataTable({

            "ajax": {
                "url": '/VenteLibre/getlisteLigneTR?cbMarq=' + @Model.cbMarq,
                "type": "get",
                "datatype": "json",

                "binfo":false,"paging": false
            },
            "columns": [
                    { "data": "Materiels" },
                    { "data": "LS_NoSerie" },
                    { "data": "Quantite" },
                    { "data": "Remise"},
                    { "data": "Taxe" },
                    { "data": "PrixUnitaire" },
                    { "data": "PrixHT" },
                    { "data": "PrixTotal" },


            ],
            "columnDefs": [
                    {
                        targets: [0],
                        render: function (data, type, row) {
                                return '<i class="label text-purplebee">'+data+'</i>';


                        }
                    }
            ]
        });

        $(document).ready(function () {

            // Bind normal buttons
            Ladda.bind('.ladda-button', { timeout: 8000 });

            // Bind progress buttons and simulate loading progress
            Ladda.bind('.progress-demo .ladda-button', {
                callback: function (instance) {
                    var progress = 0;
                    var interval = setInterval(function () {
                        progress = Math.min(progress + Math.random() * 0.1, 1);
                        instance.setProgress(progress);

                        if (progress === 1) {
                            instance.stop();
                            clearInterval(interval);
                        }
                    }, 8000);
                }
            });


            var l = Ladda.bind('.ladda-button-demo');

            l.click(function () {
                // Start loading
                l.ladda('start');

                // Timeout example
                // Do something in backend and then stop ladda
                setTimeout(function () {
                    l.ladda('stop');
                }, 15000)


            });

        });



    });

    $('#ADDArticle').click(function () {
        $("#selectArticle").modal();
    });

    $('#AjouterReglement').click(function () {
        $("#AjouterReglements").modal();
    });

    $('#validerBord').click(function () {
        $("#validerBordereau").modal();
    });


    $("select#Article").on("change", function () {

        listedesArticlesTable($('select#Article').val());




    });




    function listedesArticlesTable(arref) {

        $("#listeArticles").dataTable().fnDestroy();


        var oTable = $('#listeArticles').DataTable({
            "ajax": {
                "url": "/VenteLibre/GetStockDepotUser?Article=" + arref,
                "type": "get",
                "datatype": "json"

            },
            "columns": [

                    { "data": "AR_Ref" },
                    { "data": "AR_Design" },
                    { "data": "AS_QteSto" },
                    { "data": "AS_QteStoRes" }

            ]

        });

        $(document).ready(function () {

            // Bind normal buttons
            Ladda.bind('.ladda-button', { timeout: 8000 });

            // Bind progress buttons and simulate loading progress
            Ladda.bind('.progress-demo .ladda-button', {
                callback: function (instance) {
                    var progress = 0;
                    var interval = setInterval(function () {
                        progress = Math.min(progress + Math.random() * 0.1, 1);
                        instance.setProgress(progress);

                        if (progress === 1) {
                            instance.stop();
                            clearInterval(interval);
                        }
                    }, 8000);
                }
            });


            var l = Ladda.bind('.ladda-button-demo');

            l.click(function () {
                // Start loading
                l.ladda('start');

                // Timeout example
                // Do something in backend and then stop ladda
                setTimeout(function () {
                    l.ladda('stop');
                }, 15000)


            });

        });


    };
    function find_duplicate_in_array(arra1) {
        var object = {};
        var result = [];

        arra1.forEach(function (item) {
            if (!object[item])
                object[item] = 0;
            object[item] += 1;
        })

        for (var prop in object) {
            if (object[prop] >= 2) {
                result.push(prop);
            }
        }

        //return result;
        if (result.length > 0) {

            toastr.error('Des numéros de séries ne peuvent pas être duppliqués', 'Erreur');
        }
    }

    function ValiderADDarticle() {

       // var arref = [] ;
        //var qteDisp = [] ;

        var rows = $("#listeArticles").dataTable().fnGetNodes();
        for(var i=0;i<rows.length;i++)
        {
            var tr = $(rows[i]);
            var value = tr.find('td:eq(0)').text();
            var qtyDispo = tr.find('td:eq(2)').text();
            //arref.push(value);
            //qteDisp.push(qtyDispo);

        }

        var qtt = $('#qtyEntree').val();
        var Remise = $('#Remise').val();

        if (parseInt(qtt) > parseInt(qtyDispo)) {
            toastr.error('Quantité demandée indisponible !', 'Erreur');
        }
        else {

            $('#selectArticle').modal('hide');
            for (var rep = 0; rep < qtt; rep++) {
                addLine(value, 1, Remise);
            }
        }



    }
    function addLine(arref, qtt,Remise)
    {
        var url = "/VenteLibre/AjouterMatriels?cbmarq=" + @Model.cbMarq + "&&Article=" + arref + "&&Quantite="+ qtt+"&&Remise="+Remise;
        $.ajax({
            type: "POST",
            url: url,
            dataType: "json",
            success: function (data) {
                if(data.result==1)
                {
                    toastr.error('Veuillez selectionner au moins un article!', 'Erreur');
                }
                window.location = "/VenteLibre/Details/@Model.cbMarq";
            }
        });
    };

    function ValiderTransfert() {
        var TestDbserie = [] ;
        var serie = [] ;
        var qteDisp = [] ;
        var cbm = [] ;
        var qtdm = [];
        var test= false;
        var cells = [];
        var rows = $("#ListeTransfert").dataTable().fnGetNodes();
        for(var i=0;i<rows.length;i++)
        {
            var tr = $(rows[i]);
            var valueSerie = tr.find('td:eq(1)').find('option:selected').text();
            var valueCbmarq = tr.find('td:eq(1)').find('option:selected').val();



            serie.push(valueSerie);

            cbm.push(valueCbmarq);

            TestDbserie.push(valueSerie);

        }
        serie = serie.filter(function(item) {
            return item !== "Pas de stock";
        });
        serie = serie.filter(function(item) {
            return item !== "Aucun";
        });
        serie = serie.filter(function(item) {
            if(item.startsWith("Pas")== false){
                return item = item;
            }
        });
        serie = serie.filter(function(item) {
            if(item.startsWith("Aucun")== false){
                return item = item;
            }
        });
                serie = serie.filter(function(item) {
            return item !== "Pas de stock";
        });
        serie = serie.filter(function(item) {
            return item !== "Aucun";
        });
        serie = serie.filter(function(item) {
            if(item.startsWith("Pas")== false){
                return item = item;
            }
        });
        serie = serie.filter(function(item) {
            if(item.startsWith("Aucun")== false){
                return item = item;
            }
        });

        //var reportRecipientsDuplicate = [];
        TestDbserie = TestDbserie.filter(function(item) {
            return item !== "Pas de stock";
        });
        TestDbserie = TestDbserie.filter(function(item) {
            return item !== "Aucun";
        });
        TestDbserie = TestDbserie.filter(function(item) {
            if(item.startsWith("Pas")== false){
                return item = item;
            }
        });
        TestDbserie = TestDbserie.filter(function(item) {
            if(item.startsWith("Aucun")== false){
                return item = item;
            }
        });
        TestDbserie = TestDbserie.filter(function(item) {
            if(item.startsWith("Non Serialise")== false){
                return item = item;
            }
        });

        if(TestDbserie.length > 1){
            find_duplicate_in_array(TestDbserie);

        }



            var url = "/VenteLibre/ValiderTransfert?cbmarq=" + @Model.cbMarq + "&&serie=" + serie + "&&Marq="+ cbm;
            $.ajax({
                type: "POST",
                url: url,
                dataType: "json",
                success: function (data) {

                    if(data.result==1)
                    {
                         toastr.error('Des numéros de séries ne peuvent pas être duppliqués!', 'Erreur');
                    }

                    if(data.result==2)
                    {
                        toastr.error('Veuillez selectionnee les numeros d series souhaiter!', 'Erreur');
                    }

                    window.location = "/VenteLibre/Details/@Model.cbMarq";


                }

            });


    }

    $(function () {
        $('#cbIndice').change(function () {
            if ($('#cbIndice').val() != 2) {
                document.getElementById("ifospayement").style.display = "block";
            }
            else {
                document.getElementById("ifospayement").style.display = "none";
            }
        });




    });



</script>